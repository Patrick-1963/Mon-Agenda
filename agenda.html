<!DOCTYPE html>
<html lang="fr">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>Mon Agenda Pro</title>
<link rel="manifest" href="manifest.json">
<meta name="theme-color" content="#4F46E5">

<style>
  * {
    margin: 0;
    padding: 0;
    box-sizing: border-box;
  }

  body {
    font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, Oxygen, Ubuntu, Cantarell, sans-serif;
    background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
    min-height: 100vh;
    padding: 20px;
  }

  .container {
    max-width: 800px;
    margin: 0 auto;
    background: white;
    border-radius: 20px;
    box-shadow: 0 20px 60px rgba(0,0,0,0.3);
    overflow: hidden;
  }

  .header {
    background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
    color: white;
    padding: 30px;
    text-align: center;
  }

  .header h1 {
    font-size: 2.5em;
    margin-bottom: 10px;
  }

  .header-buttons {
    margin-top: 15px;
    display: flex;
    gap: 10px;
    justify-content: center;
    flex-wrap: wrap;
  }

  .btn {
    padding: 10px 20px;
    border: none;
    border-radius: 8px;
    cursor: pointer;
    font-size: 14px;
    font-weight: 600;
    transition: all 0.3s;
  }

  .btn-primary {
    background: #4F46E5;
    color: white;
  }

  .btn-primary:hover {
    background: #4338CA;
    transform: translateY(-2px);
  }

  .btn-secondary {
    background: white;
    color: #4F46E5;
  }

  .btn-secondary:hover {
    background: #F3F4F6;
    transform: translateY(-2px);
  }

  .btn-danger {
    background: #EF4444;
    color: white;
  }

  .btn-danger:hover {
    background: #DC2626;
  }

  .btn-success {
    background: #10B981;
    color: white;
  }

  .btn-success:hover {
    background: #059669;
  }

  .form-section {
    padding: 30px;
    background: #F9FAFB;
    border-bottom: 1px solid #E5E7EB;
  }

  .form-grid {
    display: grid;
    grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
    gap: 15px;
    margin-bottom: 15px;
  }

  .form-group {
    display: flex;
    flex-direction: column;
  }

  label {
    font-weight: 600;
    margin-bottom: 5px;
    color: #374151;
    font-size: 14px;
  }

  input, textarea, select {
    padding: 12px;
    border: 2px solid #E5E7EB;
    border-radius: 8px;
    font-size: 14px;
    transition: border-color 0.3s;
  }

  input:focus, textarea:focus, select:focus {
    outline: none;
    border-color: #4F46E5;
  }

  textarea {
    resize: vertical;
    min-height: 80px;
    font-family: inherit;
  }

  .form-actions {
    display: flex;
    gap: 10px;
    flex-wrap: wrap;
  }

  .events-section {
    padding: 30px;
  }

  .search-filter {
    margin-bottom: 20px;
    display: flex;
    gap: 10px;
    flex-wrap: wrap;
  }

  .search-filter input {
    flex: 1;
    min-width: 200px;
  }

  .date-separator {
    background: #4F46E5;
    color: white;
    padding: 12px 20px;
    border-radius: 10px;
    margin: 20px 0 15px 0;
    font-weight: 600;
    position: sticky;
    top: 0;
    z-index: 10;
  }

  .date-separator.today {
    background: #10B981;
  }

  .event {
    background: white;
    border: 2px solid #E5E7EB;
    border-radius: 12px;
    padding: 20px;
    margin-bottom: 15px;
    transition: all 0.3s;
    position: relative;
  }

  .event:hover {
    border-color: #4F46E5;
    box-shadow: 0 4px 12px rgba(79, 70, 229, 0.1);
    transform: translateY(-2px);
  }

  .event.past {
    background-color: #FEF2F2;
    border-color: #FCA5A5;
    opacity: 0.8;
  }

  .event.future {
    background-color: #F0FDF4;
    border-color: #86EFAC;
  }

  .event.today {
    background-color: #EFF6FF;
    border-color: #60A5FA;
    box-shadow: 0 0 0 3px rgba(96, 165, 250, 0.1);
  }

  .event-header {
    display: flex;
    justify-content: space-between;
    align-items: start;
    margin-bottom: 10px;
    flex-wrap: wrap;
    gap: 10px;
  }

  .event-time {
    font-size: 1.2em;
    font-weight: 700;
    color: #1F2937;
  }

  .event-category {
    display: inline-block;
    padding: 4px 12px;
    border-radius: 20px;
    font-size: 12px;
    font-weight: 600;
    text-transform: uppercase;
  }

  .category-travail { background: #DBEAFE; color: #1E40AF; }
  .category-personnel { background: #FCE7F3; color: #9F1239; }
  .category-sante { background: #D1FAE5; color: #065F46; }
  .category-loisirs { background: #FEF3C7; color: #92400E; }
  .category-autre { background: #E5E7EB; color: #374151; }

  .event-note {
    color: #4B5563;
    margin: 10px 0;
    line-height: 1.6;
  }

  .event-actions {
    display: flex;
    gap: 10px;
    margin-top: 15px;
    flex-wrap: wrap;
  }

  .event-actions button {
    padding: 8px 16px;
    font-size: 13px;
  }

  .priority-badge {
    position: absolute;
    top: 10px;
    right: 10px;
    width: 12px;
    height: 12px;
    border-radius: 50%;
  }

  .priority-haute { background: #EF4444; }
  .priority-moyenne { background: #F59E0B; }
  .priority-basse { background: #10B981; }

  .stats {
    display: grid;
    grid-template-columns: repeat(auto-fit, minmax(150px, 1fr));
    gap: 15px;
    margin-bottom: 20px;
  }

  .stat-card {
    background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
    color: white;
    padding: 20px;
    border-radius: 12px;
    text-align: center;
  }

  .stat-number {
    font-size: 2em;
    font-weight: 700;
  }

  .stat-label {
    font-size: 0.9em;
    opacity: 0.9;
  }

  .modal {
    display: none;
    position: fixed;
    top: 0;
    left: 0;
    right: 0;
    bottom: 0;
    background: rgba(0,0,0,0.5);
    z-index: 1000;
    align-items: center;
    justify-content: center;
    padding: 20px;
  }

  .modal.active {
    display: flex;
  }

  .modal-content {
    background: white;
    border-radius: 20px;
    padding: 30px;
    max-width: 500px;
    width: 100%;
    max-height: 90vh;
    overflow-y: auto;
  }

  .modal-header {
    font-size: 1.5em;
    font-weight: 700;
    margin-bottom: 20px;
    color: #1F2937;
  }

  .modal-actions {
    display: flex;
    gap: 10px;
    justify-content: flex-end;
    margin-top: 20px;
  }

  .empty-state {
    text-align: center;
    padding: 60px 20px;
    color: #9CA3AF;
  }

  .empty-state svg {
    width: 100px;
    height: 100px;
    margin-bottom: 20px;
    opacity: 0.5;
  }

  .notification-permission {
    background: #FEF3C7;
    border: 2px solid #F59E0B;
    border-radius: 12px;
    padding: 15px;
    margin-bottom: 20px;
    display: flex;
    justify-content: space-between;
    align-items: center;
    gap: 15px;
  }

  .notification-permission.hidden {
    display: none;
  }

  @media (max-width: 768px) {
    .header h1 {
      font-size: 1.8em;
    }

    .form-grid {
      grid-template-columns: 1fr;
    }

    .container {
      border-radius: 0;
    }
  }

  .recurrence-options {
    display: none;
    margin-top: 10px;
    padding: 15px;
    background: #F3F4F6;
    border-radius: 8px;
  }

  .recurrence-options.active {
    display: block;
  }

  .checkbox-group {
    display: flex;
    align-items: center;
    gap: 10px;
    margin-bottom: 10px;
  }

  .checkbox-group input[type="checkbox"] {
    width: auto;
  }
</style>

</head>
<body>

<div class="container">
  <div class="header">
    <h1>üìÖ Mon Agenda Pro</h1>
    <p>Organisez votre vie simplement</p>
    <div class="header-buttons">
      <button class="btn btn-secondary" id="gotoToday">üìç Aujourd'hui</button>
      <button class="btn btn-secondary" id="exportBtn">üíæ Exporter</button>
      <button class="btn btn-secondary" id="importBtn">üì• Importer</button>
      <button class="btn btn-secondary" id="clearAllBtn">üóëÔ∏è Tout effacer</button>
    </div>
  </div>

  <div id="notificationBanner" class="notification-permission hidden">
    <span>üîî Activez les notifications pour recevoir des rappels</span>
    <button class="btn btn-primary" id="enableNotifications">Activer</button>
  </div>

  <div class="form-section">
    <div class="form-grid">
      <div class="form-group">
        <label for="date">Date *</label>
        <input type="date" id="date" required>
      </div>
      <div class="form-group">
        <label for="time">Heure *</label>
        <input type="time" id="time" required>
      </div>
      <div class="form-group">
        <label for="category">Cat√©gorie</label>
        <select id="category">
          <option value="travail">üíº Travail</option>
          <option value="personnel">üë§ Personnel</option>
          <option value="sante">üè• Sant√©</option>
          <option value="loisirs">üé® Loisirs</option>
          <option value="autre">üìå Autre</option>
        </select>
      </div>
      <div class="form-group">
        <label for="priority">Priorit√©</label>
        <select id="priority">
          <option value="basse">üü¢ Basse</option>
          <option value="moyenne" selected>üü° Moyenne</option>
          <option value="haute">üî¥ Haute</option>
        </select>
      </div>
    </div>

    <div class="form-group">
      <label for="note">Description *</label>
      <textarea id="note" placeholder="D√©crivez votre √©v√©nement..." required></textarea>
    </div>

    <div class="checkbox-group">
      <input type="checkbox" id="notifyMe">
      <label for="notifyMe">Me notifier 15 minutes avant</label>
    </div>

    <div class="checkbox-group">
      <input type="checkbox" id="recurring">
      <label for="recurring">√âv√©nement r√©current</label>
    </div>

    <div id="recurrenceOptions" class="recurrence-options">
      <div class="form-group">
        <label for="recurrenceType">R√©p√©ter</label>
        <select id="recurrenceType">
          <option value="daily">Chaque jour</option>
          <option value="weekly">Chaque semaine</option>
          <option value="monthly">Chaque mois</option>
        </select>
      </div>
      <div class="form-group">
        <label for="recurrenceEnd">Jusqu'au</label>
        <input type="date" id="recurrenceEnd">
      </div>
    </div>

    <div class="form-actions">
      <button class="btn btn-primary" id="addBtn">‚ûï Ajouter</button>
      <button class="btn btn-success hidden" id="updateBtn">‚úì Mettre √† jour</button>
      <button class="btn btn-secondary hidden" id="cancelEditBtn">‚úó Annuler</button>
    </div>
  </div>

  <div class="events-section">
    <div class="stats" id="stats"></div>

    <div class="search-filter">
      <input type="text" id="searchInput" placeholder="üîç Rechercher un √©v√©nement...">
      <select id="filterCategory">
        <option value="">Toutes les cat√©gories</option>
        <option value="travail">üíº Travail</option>
        <option value="personnel">üë§ Personnel</option>
        <option value="sante">üè• Sant√©</option>
        <option value="loisirs">üé® Loisirs</option>
        <option value="autre">üìå Autre</option>
      </select>
      <select id="filterPriority">
        <option value="">Toutes les priorit√©s</option>
        <option value="haute">üî¥ Haute</option>
        <option value="moyenne">üü° Moyenne</option>
        <option value="basse">üü¢ Basse</option>
      </select>
    </div>

    <div id="events"></div>
  </div>
</div>

<!-- Modal de confirmation -->
<div id="confirmModal" class="modal">
  <div class="modal-content">
    <div class="modal-header">Confirmation</div>
    <p id="confirmMessage"></p>
    <div class="modal-actions">
      <button class="btn btn-secondary" id="confirmCancel">Annuler</button>
      <button class="btn btn-danger" id="confirmOk">Confirmer</button>
    </div>
  </div>
</div>

<!-- Input file cach√© pour l'import -->
<input type="file" id="importFile" accept=".json" style="display: none;">

<script>
  // √âtat de l'application
  let events = JSON.parse(localStorage.getItem("agenda") || "[]");
  let editingIndex = null;
  let notificationPermissionGranted = false;

  // Initialisation
  document.addEventListener('DOMContentLoaded', () => {
    setDefaultDate();
    checkNotificationPermission();
    render();
    setupEventListeners();
    scheduleNotifications();
  });

  // Configuration des √©couteurs d'√©v√©nements
  function setupEventListeners() {
    document.getElementById("addBtn").onclick = addEvent;
    document.getElementById("updateBtn").onclick = updateEvent;
    document.getElementById("cancelEditBtn").onclick = cancelEdit;
    document.getElementById("gotoToday").onclick = scrollToToday;
    document.getElementById("exportBtn").onclick = exportData;
    document.getElementById("importBtn").onclick = () => document.getElementById("importFile").click();
    document.getElementById("importFile").onchange = importData;
    document.getElementById("clearAllBtn").onclick = clearAll;
    document.getElementById("searchInput").oninput = render;
    document.getElementById("filterCategory").onchange = render;
    document.getElementById("filterPriority").onchange = render;
    document.getElementById("enableNotifications").onclick = requestNotificationPermission;
    document.getElementById("recurring").onchange = toggleRecurrence;
    document.getElementById("confirmCancel").onclick = () => closeModal('confirmModal');
  }

  // D√©finir la date par d√©faut
  function setDefaultDate() {
    const today = new Date().toISOString().split('T')[0];
    document.getElementById("date").value = today;
    const now = new Date();
    document.getElementById("time").value = `${String(now.getHours()).padStart(2, '0')}:${String(now.getMinutes()).padStart(2, '0')}`;
  }

  // Gestion des notifications
  function checkNotificationPermission() {
    if ("Notification" in window) {
      if (Notification.permission === "granted") {
        notificationPermissionGranted = true;
      } else if (Notification.permission !== "denied") {
        document.getElementById("notificationBanner").classList.remove("hidden");
      }
    }
  }

  async function requestNotificationPermission() {
    if ("Notification" in window) {
      const permission = await Notification.requestPermission();
      if (permission === "granted") {
        notificationPermissionGranted = true;
        document.getElementById("notificationBanner").classList.add("hidden");
        new Notification("Notifications activ√©es !", {
          body: "Vous recevrez des rappels pour vos √©v√©nements",
          icon: "agenda.webp"
        });
      }
    }
  }

  // Planifier les notifications
  function scheduleNotifications() {
    if (!notificationPermissionGranted) return;

    events.forEach(ev => {
      if (!ev.notify) return;

      const eventDate = new Date(`${ev.date}T${ev.time}`);
      const notifyTime = new Date(eventDate.getTime() - 15 * 60000); // 15 min avant
      const now = new Date();

      if (notifyTime > now) {
        const timeout = notifyTime.getTime() - now.getTime();
        if (timeout < 2147483647) { // Max timeout value
          setTimeout(() => {
            new Notification(`Rappel : ${ev.note}`, {
              body: `Dans 15 minutes (${ev.time})`,
              icon: "agenda.webp",
              tag: `event-${ev.id}`
            });
          }, timeout);
        }
      }
    });
  }

  // Toggle r√©currence
  function toggleRecurrence() {
    const recurrenceOptions = document.getElementById("recurrenceOptions");
    recurrenceOptions.classList.toggle("active", document.getElementById("recurring").checked);
  }

  // Ajouter un √©v√©nement
  function addEvent() {
    const date = document.getElementById("date").value;
    const time = document.getElementById("time").value;
    const note = document.getElementById("note").value.trim();
    const category = document.getElementById("category").value;
    const priority = document.getElementById("priority").value;
    const notify = document.getElementById("notifyMe").checked;
    const recurring = document.getElementById("recurring").checked;

    if (!date || !time || !note) {
      alert("Veuillez remplir tous les champs obligatoires !");
      return;
    }

    const newEvent = {
      id: Date.now(),
      date,
      time,
      note,
      category,
      priority,
      notify,
      createdAt: new Date().toISOString()
    };

    // Gestion de la r√©currence
    if (recurring) {
      const recurrenceType = document.getElementById("recurrenceType").value;
      const recurrenceEnd = document.getElementById("recurrenceEnd").value;
      
      if (!recurrenceEnd) {
        alert("Veuillez sp√©cifier une date de fin pour l'√©v√©nement r√©current !");
        return;
      }

      const recurringEvents = generateRecurringEvents(newEvent, recurrenceType, recurrenceEnd);
      events.push(...recurringEvents);
    } else {
      events.push(newEvent);
    }

    saveAndRender();
    clearForm();
    scrollToEvent(newEvent.id);
  }

  // G√©n√©rer des √©v√©nements r√©currents
  function generateRecurringEvents(baseEvent, type, endDate) {
    const recurringEvents = [];
    let currentDate = new Date(baseEvent.date);
    const end = new Date(endDate);

    while (currentDate <= end) {
      recurringEvents.push({
        ...baseEvent,
        id: Date.now() + recurringEvents.length,
        date: currentDate.toISOString().split('T')[0]
      });

      if (type === 'daily') {
        currentDate.setDate(currentDate.getDate() + 1);
      } else if (type === 'weekly') {
        currentDate.setDate(currentDate.getDate() + 7);
      } else if (type === 'monthly') {
        currentDate.setMonth(currentDate.getMonth() + 1);
      }
    }

    return recurringEvents;
  }

  // Modifier un √©v√©nement
  function editEvent(index) {
    editingIndex = index;
    const ev = events[index];

    document.getElementById("date").value = ev.date;
    document.getElementById("time").value = ev.time;
    document.getElementById("note").value = ev.note;
    document.getElementById("category").value = ev.category || "autre";
    document.getElementById("priority").value = ev.priority || "moyenne";
    document.getElementById("notifyMe").checked = ev.notify || false;

    document.getElementById("addBtn").classList.add("hidden");
    document.getElementById("updateBtn").classList.remove("hidden");
    document.getElementById("cancelEditBtn").classList.remove("hidden");

    document.getElementById("date").scrollIntoView({ behavior: "smooth" });
  }

  // Mettre √† jour un √©v√©nement
  function updateEvent() {
    if (editingIndex === null) return;

    const date = document.getElementById("date").value;
    const time = document.getElementById("time").value;
    const note = document.getElementById("note").value.trim();
    const category = document.getElementById("category").value;
    const priority = document.getElementById("priority").value;
    const notify = document.getElementById("notifyMe").checked;

    if (!date || !time || !note) {
      alert("Veuillez remplir tous les champs obligatoires !");
      return;
    }

    events[editingIndex] = {
      ...events[editingIndex],
      date,
      time,
      note,
      category,
      priority,
      notify,
      updatedAt: new Date().toISOString()
    };

    saveAndRender();
    cancelEdit();
  }

  // Annuler l'√©dition
  function cancelEdit() {
    editingIndex = null;
    clearForm();
    document.getElementById("addBtn").classList.remove("hidden");
    document.getElementById("updateBtn").classList.add("hidden");
    document.getElementById("cancelEditBtn").classList.add("hidden");
  }

  // Supprimer un √©v√©nement
  function removeEvent(index) {
    showConfirmModal(
      "√ätes-vous s√ªr de vouloir supprimer cet √©v√©nement ?",
      () => {
        events.splice(index, 1);
        saveAndRender();
      }
    );
  }

  // Dupliquer un √©v√©nement
  function duplicateEvent(index) {
    const ev = { ...events[index] };
    ev.id = Date.now();
    ev.createdAt = new Date().toISOString();
    events.push(ev);
    saveAndRender();
    scrollToEvent(ev.id);
  }

  // Rendu de l'interface
  function render() {
    renderStats();
    renderEvents();
  }

  // Rendu des statistiques
  function renderStats() {
    const now = new Date();
    const todayStr = now.toISOString().split("T")[0];

    const total = events.length;
    const today = events.filter(ev => ev.date === todayStr).length;
    const upcoming = events.filter(ev => new Date(ev.date + " " + ev.time) > now).length;
    const past = total - upcoming;

    const statsHTML = `
      <div class="stat-card">
        <div class="stat-number">${total}</div>
        <div class="stat-label">Total</div>
      </div>
      <div class="stat-card">
        <div class="stat-number">${today}</div>
        <div class="stat-label">Aujourd'hui</div>
      </div>
      <div class="stat-card">
        <div class="stat-number">${upcoming}</div>
        <div class="stat-label">√Ä venir</div>
      </div>
      <div class="stat-card">
        <div class="stat-number">${past}</div>
        <div class="stat-label">Pass√©s</div>
      </div>
    `;

    document.getElementById("stats").innerHTML = statsHTML;
  }

  // Rendu des √©v√©nements
  function renderEvents() {
    const container = document.getElementById("events");
    const searchTerm = document.getElementById("searchInput").value.toLowerCase();
    const filterCat = document.getElementById("filterCategory").value;
    const filterPrio = document.getElementById("filterPriority").value;

    // Filtrage
    let filteredEvents = events.filter(ev => {
      const matchSearch = ev.note.toLowerCase().includes(searchTerm);
      const matchCategory = !filterCat || ev.category === filterCat;
      const matchPriority = !filterPrio || ev.priority === filterPrio;
      return matchSearch && matchCategory && matchPriority;
    });

    if (filteredEvents.length === 0) {
      container.innerHTML = `
        <div class="empty-state">
          <svg xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" stroke="currentColor">
            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M8 7V3m8 4V3m-9 8h10M5 21h14a2 2 0 002-2V7a2 2 0 00-2-2H5a2 2 0 00-2 2v12a2 2 0 002 2z" />
          </svg>
          <h3>Aucun √©v√©nement trouv√©</h3>
          <p>Commencez par ajouter un √©v√©nement !</p>
        </div>
      `;
      return;
    }

    // Tri chronologique
    filteredEvents.sort((a, b) => {
      const da = new Date(a.date + " " + a.time);
      const db = new Date(b.date + " " + b.time);
      return da - db;
    });

    const now = new Date();
    const todayStr = now.toISOString().split("T")[0];
    let currentDate = null;
    let html = "";

    filteredEvents.forEach((ev, i) => {
      const originalIndex = events.indexOf(ev);

      // S√©parateur de date
      if (ev.date !== currentDate) {
        currentDate = ev.date;
        const isToday = ev.date === todayStr;
        html += `
          <div class="date-separator ${isToday ? 'today' : ''}" ${isToday ? 'data-date="today"' : ''}>
            ${formatDate(ev.date, todayStr)}
          </div>
        `;
      }

      const eventDate = new Date(ev.date + " " + ev.time);
      let statusClass = "";
      if (ev.date === todayStr) {
        statusClass = "today";
      } else if (eventDate < now) {
        statusClass = "past";
      } else {
        statusClass = "future";
      }

      const categoryIcons = {
        travail: "üíº",
        personnel: "üë§",
        sante: "üè•",
        loisirs: "üé®",
        autre: "üìå"
      };

      html += `
        <div class="event ${statusClass}" data-id="${ev.id}">
          <div class="priority-badge priority-${ev.priority || 'moyenne'}"></div>
          <div class="event-header">
            <div class="event-time">${ev.time}</div>
            <span class="event-category category-${ev.category || 'autre'}">
              ${categoryIcons[ev.category] || 'üìå'} ${ev.category || 'autre'}
            </span>
          </div>
          <div class="event-note">${escapeHtml(ev.note)}</div>
          ${ev.notify ? '<div style="font-size: 0.9em; color: #6B7280; margin-top: 5px;">üîî Notification activ√©e</div>' : ''}
          <div class="event-actions">
            <button class="btn btn-primary" onclick="editEvent(${originalIndex})">‚úèÔ∏è Modifier</button>
            <button class="btn btn-secondary" onclick="duplicateEvent(${originalIndex})">üìã Dupliquer</button>
            <button class="btn btn-danger" onclick="removeEvent(${originalIndex})">üóëÔ∏è Supprimer</button>
          </div>
        </div>
      `;
    });

    container.innerHTML = html;
  }

  // Formater la date
  function formatDate(dateStr, todayStr) {
    if (dateStr === todayStr) return "üìÖ Aujourd'hui";

    const d = new Date(dateStr);
    const today = new Date(todayStr);
    const tomorrow = new Date(today);
    tomorrow.setDate(tomorrow.getDate() + 1);

    if (dateStr === tomorrow.toISOString().split('T')[0]) {
      return "üìÖ Demain";
    }

    return "üìÖ " + d.toLocaleDateString("fr-FR", {
      weekday: "long",
      day: "numeric",
      month: "long",
      year: "numeric"
    });
  }

  // √âchapper HTML
  function escapeHtml(text) {
    const div = document.createElement('div');
    div.textContent = text;
    return div.innerHTML;
  }

  // Sauvegarder et re-rendre
  function saveAndRender() {
    localStorage.setItem("agenda", JSON.stringify(events));
    render();
    scheduleNotifications();
  }

  // Effacer le formulaire
  function clearForm() {
    document.getElementById("note").value = "";
    document.getElementById("category").value = "travail";
    document.getElementById("priority").value = "moyenne";
    document.getElementById("notifyMe").checked = false;
    document.getElementById("recurring").checked = false;
    document.getElementById("recurrenceOptions").classList.remove("active");
    setDefaultDate();
  }

  // D√©filer jusqu'√† aujourd'hui
  function scrollToToday() {
    const todaySection = document.querySelector("[data-date='today']");
    if (todaySection) {
      todaySection.scrollIntoView({ behavior: "smooth", block: "start" });
    } else {
      alert("Aucun √©v√©nement pr√©vu aujourd'hui.");
    }
  }

  // D√©filer jusqu'√† un √©v√©nement
  function scrollToEvent(eventId) {
    setTimeout(() => {
      const eventEl = document.querySelector(`[data-id="${eventId}"]`);
      if (eventEl) {
        eventEl.scrollIntoView({ behavior: "smooth", block: "center" });
      }
    }, 100);
  }

  // Exporter les donn√©es
  function exportData() {
    const dataStr = JSON.stringify(events, null, 2);
    const dataBlob = new Blob([dataStr], { type: 'application/json' });
    const url = URL.createObjectURL(dataBlob);
    const link = document.createElement('a');
    link.href = url;
    link.download = `agenda_export_${new Date().toISOString().split('T')[0]}.json`;
    link.click();
    URL.revokeObjectURL(url);
  }

  // Importer les donn√©es
  function importData(event) {
    const file = event.target.files[0];
    if (!file) return;

    const reader = new FileReader();
    reader.onload = (e) => {
      try {
        const importedEvents = JSON.parse(e.target.result);
        if (!Array.isArray(importedEvents)) {
          throw new Error("Format invalide");
        }

        showConfirmModal(
          `Voulez-vous importer ${importedEvents.length} √©v√©nement(s) ? Cela remplacera vos donn√©es actuelles.`,
          () => {
            events = importedEvents;
            saveAndRender();
            alert("Import r√©ussi !");
          }
        );
      } catch (err) {
        alert("Erreur lors de l'import : fichier invalide");
      }
    };
    reader.readAsText(file);
    event.target.value = "";
  }

  // Tout effacer
  function clearAll() {
    if (events.length === 0) {
      alert("Aucun √©v√©nement √† supprimer");
      return;
    }

    showConfirmModal(
      `√ätes-vous s√ªr de vouloir supprimer TOUS les ${events.length} √©v√©nements ? Cette action est irr√©versible.`,
      () => {
        events = [];
        saveAndRender();
        alert("Tous les √©v√©nements ont √©t√© supprim√©s");
      }
    );
  }

  // Modal de confirmation
  function showConfirmModal(message, onConfirm) {
    document.getElementById("confirmMessage").textContent = message;
    document.getElementById("confirmModal").classList.add("active");
    
    document.getElementById("confirmOk").onclick = () => {
      onConfirm();
      closeModal('confirmModal');
    };
  }

  function closeModal(modalId) {
    document.getElementById(modalId).classList.remove("active");
  }

  // Service Worker
  if ("serviceWorker" in navigator) {
    navigator.serviceWorker.register("service-worker.js")
      .then(() => console.log("Service Worker enregistr√©"))
      .catch(err => console.error("Erreur Service Worker:", err));
  }
</script>

</body>
</html>
